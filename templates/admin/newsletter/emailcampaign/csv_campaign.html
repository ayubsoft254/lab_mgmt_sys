{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:newsletter_emailcampaign_changelist' %}">Email campaigns</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="form-row">
    <div class="help">
        <p><strong>CSV Format Requirements:</strong></p>
        <ul>
            <li>CSV file must contain exactly these columns: <code>email, name, reg, course, hostel, room</code></li>
            <li>All columns are required and cannot be empty</li>
            <li>Use these column names as placeholders in your email content</li>
            <li>In your email content, use placeholders like: {{ name }}, {{ reg }}, {{ course }}, {{ hostel }}, {{ room }}</li>
        </ul>
        <p><strong>Required CSV Format:</strong></p>
        <pre>email,name,reg,course,hostel,room
john.doe@example.com,John Doe,CS001,Computer Science,Block A,101
jane.smith@example.com,Jane Smith,CS002,Information Technology,Block B,205</pre>
        <p><strong>Available Placeholders:</strong></p>
        <ul>
            <li><code>{{ email }}</code> - Student email address</li>
            <li><code>{{ name }}</code> - Student full name</li>
            <li><code>{{ reg }}</code> - Registration number</li>
            <li><code>{{ course }}</code> - Course name</li>
            <li><code>{{ hostel }}</code> - Hostel name</li>
            <li><code>{{ room }}</code> - Room number</li>
        </ul>
    </div>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <fieldset class="module aligned">
        <h2>Campaign Information</h2>
        <div class="form-row">
            {{ form.name.label_tag }}
            {{ form.name }}
            {% if form.name.errors %}
                <ul class="errorlist">
                    {% for error in form.name.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        
        <div class="form-row">
            {{ form.subject.label_tag }}
            {{ form.subject }}
            {% if form.subject.errors %}
                <ul class="errorlist">
                    {% for error in form.subject.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <div class="help">You can use placeholders like {{ name }}, {{ course }}, {{ hostel }} in the subject</div>
        </div>
        
        <div class="form-row">
            {{ form.sender_email_choice.label_tag }}
            {{ form.sender_email_choice }}
            {% if form.sender_email_choice.errors %}
                <ul class="errorlist">
                    {% for error in form.sender_email_choice.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <div class="help">{{ form.sender_email_choice.help_text }}</div>
        </div>
        
        <div class="form-row" id="custom-email-row" style="display: none;">
            {{ form.custom_sender_email.label_tag }}
            {{ form.custom_sender_email }}
            {% if form.custom_sender_email.errors %}
                <ul class="errorlist">
                    {% for error in form.custom_sender_email.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <div class="help">{{ form.custom_sender_email.help_text }}</div>
        </div>
    </fieldset>
    
    <fieldset class="module aligned">
        <h2>Content</h2>
        <div class="form-row">
            {{ form.template.label_tag }}
            {{ form.template }}
            {% if form.template.errors %}
                <ul class="errorlist">
                    {% for error in form.template.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        
        <div class="form-row">
            {{ form.custom_html_content.label_tag }}
            {{ form.custom_html_content }}
            {% if form.custom_html_content.errors %}
                <ul class="errorlist">
                    {% for error in form.custom_html_content.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <div class="help">
                <p>Use these placeholders from your CSV:</p>
                <p><strong>{{ name }}</strong> - Student name | <strong>{{ reg }}</strong> - Registration | <strong>{{ course }}</strong> - Course | <strong>{{ hostel }}</strong> - Hostel | <strong>{{ room }}</strong> - Room</p>
                <p>Example: "Dear {{ name }}, your room {{ room }} in {{ hostel }} has been assigned for {{ course }}."</p>
            </div>
        </div>
        
        <div class="form-row">
            {{ form.custom_text_content.label_tag }}
            {{ form.custom_text_content }}
            {% if form.custom_text_content.errors %}
                <ul class="errorlist">
                    {% for error in form.custom_text_content.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <div class="help">Plain text version using the same placeholders as above</div>
        </div>
    </fieldset>
    
    <fieldset class="module aligned">
        <h2>CSV Upload</h2>
        <div class="form-row">
            {{ form.csv_file.label_tag }}
            {{ form.csv_file }}
            {% if form.csv_file.errors %}
                <ul class="errorlist">
                    {% for error in form.csv_file.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <div class="help">{{ form.csv_file.help_text }}</div>
        </div>
    </fieldset>
    
    <fieldset class="module aligned">
        <h2>Schedule (Optional)</h2>
        <div class="form-row">
            {{ form.scheduled_time.label_tag }}
            {{ form.scheduled_time }}
            {% if form.scheduled_time.errors %}
                <ul class="errorlist">
                    {% for error in form.scheduled_time.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            <div class="help">Leave blank to send immediately after creation</div>
        </div>
    </fieldset>
    
    <div class="submit-row">
        <input type="submit" value="Create CSV Campaign" class="default" />
        <a href="{% url 'admin:newsletter_emailcampaign_changelist' %}" class="button cancel-link">Cancel</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const senderChoice = document.querySelector('#id_sender_email_choice');
    const customEmailRow = document.querySelector('#custom-email-row');
    const templateField = document.querySelector('#id_template');
    const htmlField = document.querySelector('#id_custom_html_content');
    const textField = document.querySelector('#id_custom_text_content');
    
    // Show/hide custom email field based on selection
    function toggleCustomEmailField() {
        if (senderChoice.value === 'custom') {
            customEmailRow.style.display = 'block';
        } else {
            customEmailRow.style.display = 'none';
        }
    }
    
    // Show/hide template vs custom content
    function toggleCustomContent() {
        const hasTemplate = templateField.value !== '';
        htmlField.closest('.form-row').style.display = hasTemplate ? 'none' : 'block';
        textField.closest('.form-row').style.display = hasTemplate ? 'none' : 'block';
    }
    
    if (senderChoice) {
        senderChoice.addEventListener('change', toggleCustomEmailField);
        toggleCustomEmailField(); // Initial call
    }
    
    if (templateField) {
        templateField.addEventListener('change', toggleCustomContent);
        toggleCustomContent(); // Initial call
    }
});
</script>
{% endblock %}