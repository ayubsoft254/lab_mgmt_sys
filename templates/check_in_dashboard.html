{% extends 'base.html' %}
{% load static %}
{% load booking_extras %}

{% block title %}Check-in Dashboard - Lab Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                <i class="fas fa-clipboard-check me-2 text-ttu-green"></i>
                                Attendance Dashboard - {{ today|date:"l, F j, Y" }}
                            </h5>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center gap-2">
                                <!-- Search Box -->
                                <div class="flex-grow-1">
                                    <input type="text" id="studentSearch" class="form-control form-control-sm" placeholder="Search student name or ID...">
                                </div>
                                <!-- View Toggle -->
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary active view-toggle" data-view="table">
                                        <i class="fas fa-list"></i> List
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary view-toggle" data-view="cards">
                                        <i class="fas fa-th"></i> Cards
                                    </button>
                                </div>
                                <!-- Date navigation -->
                                <form class="d-flex align-items-center" method="get" style="gap: 0.5rem;">
                                    <div class="input-group input-group-sm" style="max-width: 200px;">
                                        <input type="date" name="date" class="form-control" value="{{ today|date:'Y-m-d' }}">
                                        <button class="btn btn-outline-secondary" type="submit">Go</button>
                                    </div>
                                    <a href="?date={{ today|date:'Y-m-d' }}" class="btn btn-outline-secondary btn-sm">Today</a>
                                    <a href="?date={{ tomorrow|date:'Y-m-d' }}" class="btn btn-outline-secondary btn-sm">Tomorrow</a>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Stats Row with improved styling -->
                    <div class="row mb-4 g-3">
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card stat-primary p-3 rounded border-start border-5 border-info bg-light">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="text-muted small mb-1">Total Expected</p>
                                        <h2 class="mb-0 text-info fw-bold">{{ booking_attendance.total }}</h2>
                                    </div>
                                    <i class="fas fa-users fa-2x text-info opacity-25"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card stat-success p-3 rounded border-start border-5 border-success bg-light">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="text-muted small mb-1">Present</p>
                                        <h2 class="mb-0 text-success fw-bold">{{ booking_attendance.checked_in }}</h2>
                                        <small class="text-muted">
                                            {% if booking_attendance.total > 0 %}
                                                ({{ booking_attendance.checked_in }}/{{ booking_attendance.total }})
                                            {% endif %}
                                        </small>
                                    </div>
                                    <i class="fas fa-check-circle fa-2x text-success opacity-25"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card stat-warning p-3 rounded border-start border-5 border-warning bg-light">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="text-muted small mb-1">Late Arrivals</p>
                                        <h2 class="mb-0 text-warning fw-bold">{{ booking_attendance.late }}</h2>
                                        <small class="text-muted">arrived after scheduled time</small>
                                    </div>
                                    <i class="fas fa-clock fa-2x text-warning opacity-25"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card stat-danger p-3 rounded border-start border-5 border-danger bg-light">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="text-muted small mb-1">No-shows</p>
                                        <h2 class="mb-0 text-danger fw-bold">{{ booking_attendance.absent }}</h2>
                                        <small class="text-muted">not checked in</small>
                                    </div>
                                    <i class="fas fa-times-circle fa-2x text-danger opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Filter Tabs -->
                    <div class="mb-3">
                        <div class="btn-group btn-group-sm w-100 d-flex" role="group">
                            <input type="radio" class="btn-check status-filter" name="status-filter" id="filter-all" value="all" checked>
                            <label class="btn btn-outline-secondary flex-grow-1" for="filter-all">
                                All ({{ booking_attendance.total }})
                            </label>
                            
                            <input type="radio" class="btn-check status-filter" name="status-filter" id="filter-pending" value="pending">
                            <label class="btn btn-outline-secondary flex-grow-1" for="filter-pending">
                                Pending ({{ pending_count|default:"0" }})
                            </label>
                            
                            <input type="radio" class="btn-check status-filter" name="status-filter" id="filter-present" value="present">
                            <label class="btn btn-outline-secondary flex-grow-1" for="filter-present">
                                Present ({{ booking_attendance.checked_in }})
                            </label>
                            
                            <input type="radio" class="btn-check status-filter" name="status-filter" id="filter-late" value="late">
                            <label class="btn btn-outline-secondary flex-grow-1" for="filter-late">
                                Late ({{ booking_attendance.late }})
                            </label>
                            
                            <input type="radio" class="btn-check status-filter" name="status-filter" id="filter-absent" value="absent">
                            <label class="btn btn-outline-secondary flex-grow-1" for="filter-absent">
                                Absent ({{ booking_attendance.absent }})
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Computer Bookings -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-desktop me-2 text-ttu-green"></i>
                            Computer Bookings
                        </h5>
                        <span class="badge bg-light text-dark">{{ today_bookings|length }} bookings</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- List View -->
                    <div class="booking-list-view" id="bookingListView">
                        {% if today_bookings %}
                            <div class="list-group list-group-flush">
                                {% for booking in today_bookings %}
                                <div class="list-group-item booking-row {% if booking.attendance %}checked-in{% elif booking.start_time <= now %}overdue{% endif %}" data-booking-id="{{ booking.id }}" data-status="{% if booking.attendance %}{{ booking.attendance.status }}{% else %}pending{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <!-- Left: Student Info -->
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center gap-2">
                                                <!-- Student Avatar -->
                                                <div class="avatar-circle bg-ttu-green text-white d-flex align-items-center justify-content-center fw-bold" style="width: 40px; height: 40px; border-radius: 50%; font-size: 14px;">
                                                    {{ booking.student.first_name|first }}{{ booking.student.last_name|first }}
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">{{ booking.student.get_full_name }}</h6>
                                                    <small class="text-muted">{{ booking.student.username }}</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Middle: Time & Computer Info -->
                                        <div class="text-center mx-3">
                                            <small class="text-muted d-block">{{ booking.computer }}</small>
                                            <div class="small fw-semibold">{{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}</div>
                                            {% if booking.start_time <= now %}
                                                <span class="badge bg-danger small mt-1">
                                                    <i class="fas fa-exclamation-circle me-1"></i>
                                                    {% if booking.attendance %}
                                                        Checked in
                                                    {% else %}
                                                        Overdue
                                                    {% endif %}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-info small mt-1">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Upcoming
                                                </span>
                                            {% endif %}
                                        </div>

                                        <!-- Right: Status & Actions -->
                                        <div class="text-end" style="min-width: 150px;">
                                            <div class="mb-2">
                                                {% if booking.attendance %}
                                                    <span class="badge {% if booking.attendance.status == 'present' %}bg-success{% elif booking.attendance.status == 'late' %}bg-warning{% elif booking.attendance.status == 'excused' %}bg-info{% else %}bg-danger{% endif %} larger-badge">
                                                        <i class="fas {% if booking.attendance.status == 'present' %}fa-check-circle{% elif booking.attendance.status == 'late' %}fa-clock{% elif booking.attendance.status == 'excused' %}fa-ban{% else %}fa-times-circle{% endif %} me-1"></i>
                                                        {{ booking.attendance.get_status_display }}
                                                    </span>
                                                    {% if booking.attendance.check_in_time %}
                                                        <br>
                                                        <small class="text-muted d-block mt-1">{{ booking.attendance.check_in_time|time:"H:i" }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-secondary">Not Checked</span>
                                                {% endif %}
                                            </div>
                                            <!-- Action Buttons -->
                                            <div class="btn-group btn-group-sm" role="group" style="width: 100%;">
                                                {% if not booking.attendance %}
                                                    <button type="button" class="btn btn-success btn-sm quick-check-in flex-grow-1" data-booking-id="{{ booking.id }}" data-status="present" title="Check in - Present">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-warning btn-sm quick-check-in flex-grow-1" data-booking-id="{{ booking.id }}" data-status="late" title="Check in - Late">
                                                        <i class="fas fa-clock"></i>
                                                    </button>
                                                {% endif %}
                                                <a href="{% url 'computer_booking_check_in' booking.id %}" class="btn btn-primary btn-sm flex-grow-1" title="View Details">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                                <p class="text-muted">No computer bookings for today</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Card View -->
                    <div class="booking-card-view d-none" id="bookingCardView">
                        <div class="row g-3 p-3">
                            {% if today_bookings %}
                                {% for booking in today_bookings %}
                                <div class="col-md-6 booking-card-item" data-booking-id="{{ booking.id }}" data-status="{% if booking.attendance %}{{ booking.attendance.status }}{% else %}pending{% endif %}">
                                    <div class="card h-100 border-start border-5 {% if booking.attendance %}border-{% if booking.attendance.status == 'present' %}success{% elif booking.attendance.status == 'late' %}warning{% else %}danger{% endif %}{% elif booking.start_time <= now %}border-danger{% else %}border-info{% endif %}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start justify-content-between mb-2">
                                                <div class="d-flex align-items-center gap-2">
                                                    <div class="avatar-circle bg-ttu-green text-white d-flex align-items-center justify-content-center fw-bold" style="width: 50px; height: 50px; border-radius: 50%; font-size: 16px;">
                                                        {{ booking.student.first_name|first }}{{ booking.student.last_name|first }}
                                                    </div>
                                                </div>
                                                {% if booking.attendance %}
                                                    <span class="badge {% if booking.attendance.status == 'present' %}bg-success{% elif booking.attendance.status == 'late' %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ booking.attendance.get_status_display }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge {% if booking.start_time <= now %}bg-danger{% else %}bg-info{% endif %}">
                                                        {% if booking.start_time <= now %}Overdue{% else %}Upcoming{% endif %}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <h6 class="card-title mb-1">{{ booking.student.get_full_name }}</h6>
                                            <small class="text-muted d-block mb-2">{{ booking.student.username }}</small>
                                            
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-desktop me-1"></i>{{ booking.computer }}
                                                </small>
                                            </div>
                                            <div class="mb-3">
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>{{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}
                                                </small>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <a href="{% url 'computer_booking_check_in' booking.id %}" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-check-circle me-1"></i> Check In
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>No computer bookings for today
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lab Sessions -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2 text-ttu-green"></i>
                            Lab Sessions
                        </h5>
                        <span class="badge bg-light text-dark">{{ today_sessions|length }} sessions</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- List View -->
                    <div class="session-list-view" id="sessionListView">
                        {% if today_sessions %}
                            <div class="list-group list-group-flush">
                                {% for session in today_sessions %}
                                <div class="list-group-item session-row {% if session.start_time <= now %}active{% else %}upcoming{% endif %}" data-session-id="{{ session.id }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <!-- Left: Session Info -->
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ session.title }}</h6>
                                            <small class="text-muted d-block">{{ session.lecturer.get_full_name }} • {{ session.lab.name }}</small>
                                            <small class="text-muted d-block mt-1">{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}</small>
                                        </div>

                                        <!-- Right: Attendance Info & Actions -->
                                        <div class="text-end">
                                            <div class="mb-2">
                                                <span class="badge bg-light text-dark">
                                                    <i class="fas fa-users me-1"></i>{{ session.attending_students.count }} students
                                                </span>
                                                {% if session_attendance %}
                                                    {% with present_count=session_attendance|get_item:session.id|default:0 %}
                                                        {% if present_count > 0 %}
                                                            <br>
                                                            <span class="badge bg-success small mt-1">
                                                                <i class="fas fa-check-circle me-1"></i>{{ present_count }} present
                                                            </span>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            </div>
                                            <a href="{% url 'lab_session_attendance' session.id %}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-clipboard-list me-1"></i> Manage
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                                <p class="text-muted">No lab sessions for today</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Card View -->
                    <div class="session-card-view d-none" id="sessionCardView">
                        <div class="row g-3 p-3">
                            {% if today_sessions %}
                                {% for session in today_sessions %}
                                <div class="col-md-6 session-card-item" data-session-id="{{ session.id }}">
                                    <div class="card h-100 border-start border-5 {% if session.start_time <= now %}border-success{% else %}border-info{% endif %}">
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <span class="badge {% if session.start_time <= now %}bg-success{% else %}bg-info{% endif %}">
                                                    {% if session.start_time <= now %}Active{% else %}Upcoming{% endif %}
                                                </span>
                                            </div>
                                            <h6 class="card-title mb-2">{{ session.title }}</h6>
                                            <small class="text-muted d-block mb-1">
                                                <i class="fas fa-user-tie me-1"></i>{{ session.lecturer.get_full_name }}
                                            </small>
                                            <small class="text-muted d-block mb-1">
                                                <i class="fas fa-building me-1"></i>{{ session.lab.name }}
                                            </small>
                                            <small class="text-muted d-block mb-3">
                                                <i class="fas fa-clock me-1"></i>{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}
                                            </small>

                                            <div class="mb-3">
                                                <small class="text-muted d-block mb-1">Attendance:</small>
                                                <h5 class="mb-0">{{ session.attending_students.count }} <small class="text-muted">/ students</small></h5>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <a href="{% url 'lab_session_attendance' session.id %}" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-clipboard-list me-1"></i> Record Attendance
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>No lab sessions for today
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if request.user.is_superuser %}
    <div class="mt-4 card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Debug Information</h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#debugInfo">
                Toggle
            </button>
        </div>
        <div class="card-body collapse" id="debugInfo">
            <!-- Basic debug info -->
            <div class="row">
                <div class="col-md-6">
                    <h6>Date/Time Info</h6>
                    <ul class="list-unstyled">
                        <li><strong>Today:</strong> {{ debug_info.today }}</li>
                        <li><strong>Current time:</strong> {{ debug_info.now }}</li>
                    </ul>
                    
                    <h6>Bookings Info</h6>
                    <ul class="list-unstyled">
                        <li><strong>Total bookings in system:</strong> {{ all_bookings_count }}</li>
                        <li><strong>Bookings for today:</strong> {{ debug_info.today_bookings_count }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Sessions Info</h6>
                    <ul class="list-unstyled">
                        <li><strong>Total sessions in system:</strong> {{ all_sessions_count }}</li>
                        <li><strong>Sessions for today:</strong> {{ debug_info.today_sessions_count }}</li>
                    </ul>
                </div>
            </div>
            
            <!-- Sample data info -->
            <div class="row mt-3">
                <div class="col-md-6">
                    {% if debug_info.sample_bookings %}
                        <h6>Sample bookings:</h6>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student</th>
                                    <th>Start</th>
                                    <th>End</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in debug_info.sample_bookings %}
                                    <tr>
                                        <td>{{ booking.id }}</td>
                                        <td>{{ booking.student }}</td>
                                        <td>{{ booking.start }}</td>
                                        <td>{{ booking.end }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if debug_info.sample_sessions %}
                        <h6>Sample sessions:</h6>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Start</th>
                                    <th>End</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in debug_info.sample_sessions %}
                                    <tr>
                                        <td>{{ session.id }}</td>
                                        <td>{{ session.title }}</td>
                                        <td>{{ session.start }}</td>
                                        <td>{{ session.end }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<style>
    /* Enhanced styling for check-in dashboard */
    .avatar-circle {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 14px;
    }

    .stat-card {
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .booking-row {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }

    .booking-row:hover {
        background-color: #f8f9fa;
    }

    .booking-row.checked-in {
        background-color: #f0f8f4;
    }

    .booking-row.overdue {
        background-color: #fff5f5;
    }

    .session-row {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }

    .session-row:hover {
        background-color: #f8f9fa;
    }

    .larger-badge {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }

    .status-filter {
        display: none;
    }

    .status-filter:checked + label {
        background-color: #2c6e49 !important;
        color: white !important;
        border-color: #2c6e49 !important;
    }

    .view-toggle.active {
        background-color: #2c6e49 !important;
        color: white !important;
        border-color: #2c6e49 !important;
    }

    .booking-card-item,
    .session-card-item {
        transition: all 0.2s ease;
    }

    .booking-card-item:hover,
    .session-card-item:hover {
        transform: translateY(-4px);
    }

    .booking-card-item .card,
    .session-card-item .card {
        transition: all 0.2s ease;
    }

    .booking-card-item:hover .card,
    .session-card-item:hover .card {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .btn-group-sm > .btn,
    .btn-group-sm > .btn-group > .btn {
        border-radius: 0.25rem;
    }

    @media (max-width: 768px) {
        .booking-row,
        .session-row {
            padding: 0.75rem;
        }

        .avatar-circle {
            width: 36px !important;
            height: 36px !important;
            font-size: 12px;
        }

        .btn-group-sm {
            gap: 0.25rem;
        }

        .booking-row .btn-group-sm {
            flex-wrap: wrap;
        }
    }

    /* Hide elements based on filters */
    .booking-row.hidden,
    .session-row.hidden {
        display: none;
    }

    /* Empty state styling */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentSearch = document.getElementById('studentSearch');
    const statusFilters = document.querySelectorAll('.status-filter');
    const viewToggles = document.querySelectorAll('.view-toggle');
    
    // Search functionality
    if (studentSearch) {
        studentSearch.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const bookingRows = document.querySelectorAll('.booking-row, .booking-card-item');
            
            bookingRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.classList.toggle('hidden', !text.includes(searchTerm));
            });
        });
    }

    // Status filter functionality
    statusFilters.forEach(filter => {
        filter.addEventListener('change', function() {
            filterByStatus(this.value);
        });
    });

    function filterByStatus(status) {
        const bookingRows = document.querySelectorAll('.booking-row');
        const bookingCards = document.querySelectorAll('.booking-card-item');
        
        bookingRows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === 'all' || rowStatus === status) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        });

        bookingCards.forEach(card => {
            const cardStatus = card.getAttribute('data-status');
            if (status === 'all' || cardStatus === status) {
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        });
    }

    // View toggle functionality
    viewToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            
            // Update active state
            viewToggles.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Toggle views
            const listView = document.getElementById('bookingListView');
            const cardView = document.getElementById('bookingCardView');
            
            if (view === 'cards') {
                listView.classList.add('d-none');
                cardView.classList.remove('d-none');
            } else {
                listView.classList.remove('d-none');
                cardView.classList.add('d-none');
            }

            // Save preference
            localStorage.setItem('checkinViewPreference', view);
        });
    });

    // Restore view preference
    const savedView = localStorage.getItem('checkinViewPreference') || 'table';
    const viewBtn = document.querySelector(`[data-view="${savedView}"]`);
    if (viewBtn && savedView === 'cards') {
        viewBtn.click();
    }

    // Quick check-in buttons
    document.querySelectorAll('.quick-check-in').forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-booking-id');
            const status = this.getAttribute('data-status');
            const row = this.closest('.booking-row');
            const statusCell = row.querySelector('.larger-badge');
            const actionButtons = row.querySelectorAll('.quick-check-in');
            
            // Disable buttons immediately to prevent double-clicks
            actionButtons.forEach(btn => btn.disabled = true);
            
            // Add loading indicator
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            
            // Send AJAX request
            fetch(`/check-in/quick/${bookingId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `status=${status}&notes=Quick check-in via dashboard`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                
                if (data.status === 'success') {
                    // Update UI
                    const badgeClass = status === 'present' ? 'bg-success' : 'bg-warning';
                    statusCell.innerHTML = `
                        <span class="badge ${badgeClass} larger-badge">
                            <i class="fas ${status === 'present' ? 'fa-check-circle' : 'fa-clock'} me-1"></i>
                            ${data.attendance.status_display}
                        </span>
                        <br>
                        <small class="text-muted d-block mt-1">${data.attendance.check_in_time}</small>
                    `;
                    
                    // Update row status
                    row.classList.add('checked-in');
                    row.setAttribute('data-status', status);
                    
                    // Restore button UI but keep disabled
                    this.innerHTML = status === 'present' ? 
                        '<i class="fas fa-check"></i>' : 
                        '<i class="fas fa-clock"></i>';
                    
                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alert.innerHTML = `
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        <i class="fas fa-check-circle me-2"></i>Attendance marked successfully!
                    `;
                    document.querySelector('.container-fluid').prepend(alert);
                    
                    // Remove alert after 3 seconds
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                } else {
                    // Re-enable buttons if there was an error in the response
                    actionButtons.forEach(btn => btn.disabled = false);
                    this.innerHTML = status === 'present' ? 
                        '<i class="fas fa-check"></i>' : 
                        '<i class="fas fa-clock"></i>';
                    throw new Error('Server returned error status: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Re-enable buttons
                actionButtons.forEach(btn => btn.disabled = false);
                this.innerHTML = status === 'present' ? 
                    '<i class="fas fa-check"></i>' : 
                    '<i class="fas fa-clock"></i>';
                
                // Show error message
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alert.innerHTML = `
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <i class="fas fa-exclamation-circle me-2"></i>Failed to record attendance: ${error.message || 'Please try again.'}
                `;
                document.querySelector('.container-fluid').prepend(alert);
                
                // Remove alert after 3 seconds
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            });
        });
    });
});
</script>
{% endblock %}