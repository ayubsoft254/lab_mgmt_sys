{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .doc-sidebar {
        position: sticky;
        top: 80px;
        height: calc(100vh - 100px);
        overflow-y: auto;
    }
    
    .doc-content h2 {
        padding-top: 80px;
        margin-top: -60px;
    }
    
    .doc-content h3 {
        padding-top: 80px;
        margin-top: -60px;
    }
    
    .doc-section {
        scroll-margin-top: 80px;
    }
    
    .doc-link {
        @apply text-ttu-green hover:text-ttu-dark hover:underline;
    }
    
    @media print {
        .doc-sidebar, .no-print {
            display: none;
        }
        .doc-content {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Sidebar Navigation -->
            <div class="md:w-1/4 doc-sidebar no-print">
                <div class="bg-white shadow rounded-lg p-6 mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Contents</h3>
                    <nav class="space-y-1">
                        {% for section in sections %}
                        <div class="mb-3">
                            <a href="#{{ section.id }}" class="text-ttu-green hover:text-ttu-dark font-medium">{{ section.title }}</a>
                            
                            {% if section.subsections %}
                            <ul class="pl-4 mt-1 space-y-1">
                                {% for subsection in section.subsections %}
                                <li>
                                    <a href="#{{ subsection.id }}" class="text-sm text-gray-600 hover:text-ttu-green">{{ subsection.title }}</a>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </nav>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <button onclick="window.print()" class="flex items-center text-sm text-gray-600 hover:text-ttu-green">
                            <i class="fas fa-print mr-2"></i> Print Documentation
                        </button>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Version Info</h3>
                    <div class="text-sm text-gray-600">
                        <div class="flex justify-between mb-1">
                            <span>Version:</span>
                            <span class="font-medium">{{ version.number }}</span>
                        </div>
                        {% if version.name %}
                        <div class="flex justify-between mb-1">
                            <span>Name:</span>
                            <span class="font-medium">{{ version.name }}</span>
                        </div>
                        {% endif %}
                        {% if version.type %}
                        <div class="flex justify-between mb-1">
                            <span>Type:</span>
                            <span class="font-medium">{{ version.type }}</span>
                        </div>
                        {% endif %}
                        <div class="flex justify-between mb-1">
                            <span>Last Updated:</span>
                            <span class="font-medium">{{ version.date }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Developed by:</span>
                            <span class="font-medium">{{ version.developer }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="md:w-3/4 doc-content">
                <div class="bg-white shadow rounded-lg p-6 md:p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">{{ title }}</h1>
                        <img src="https://schools.ttu.ac.ke/static/images/logo.jpg" alt="TTU Logo" class="h-10 md:h-12">
                    </div>
                    
                    <!-- Table of Contents for mobile -->
                    <div class="md:hidden bg-gray-50 p-4 rounded-lg mb-8">
                        <details>
                            <summary class="font-medium text-gray-800">Table of Contents</summary>
                            <nav class="mt-3 space-y-1">
                                {% for section in sections %}
                                <div class="py-1">
                                    <a href="#{{ section.id }}" class="text-ttu-green hover:underline">{{ section.title }}</a>
                                </div>
                                {% endfor %}
                            </nav>
                        </details>
                    </div>
                    
                    <!-- Document Sections -->
                    {% for section in sections %}
                    <section id="{{ section.id }}" class="doc-section mb-12">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4 pb-2 border-b border-gray-200">
                            {{ section.title }}
                        </h2>
                        
                        {% if section.content %}
                        <div class="prose max-w-none">
                            <p>{{ section.content|safe }}</p>
                        </div>
                        {% endif %}
                        
                        {% if section.subsections %}
                            {% for subsection in section.subsections %}
                            <div id="{{ subsection.id }}" class="mt-8">
                                <h3 class="text-xl font-semibold text-gray-800 mb-3">{{ subsection.title }}</h3>
                                
                                {% if subsection.content %}
                                <div class="prose max-w-none">
                                    <p>{{ subsection.content|safe }}</p>
                                </div>
                                {% endif %}
                                
                                {% if subsection.items %}
                                <ul class="mt-3 list-disc pl-5 space-y-1">
                                    {% for item in subsection.items %}
                                    <li class="text-gray-700">{{ item }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        {% if section.contacts %}
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-gray-800 mb-2">Contact Information</h3>
                            <div class="space-y-2">
                                {% for contact in section.contacts %}
                                <div class="flex flex-wrap items-center">
                                    <span class="font-medium text-gray-700 mr-2">{{ contact.title }}:</span>
                                    {% if contact.email %}
                                    <a href="mailto:{{ contact.email }}" class="text-ttu-green hover:underline">{{ contact.email }}</a>
                                    {% endif %}
                                    {% if contact.text %}
                                    <span class="text-gray-700">{{ contact.text }}</span>
                                    {% endif %}
                                    {% if contact.additional_info %}
                                    <div class="w-full mt-1 text-sm text-gray-600">
                                        {{ contact.additional_info|safe }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </section>
                    {% endfor %}
                    
                    <!-- Footer -->
                    <div class="mt-12 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
                        <p>&copy; {% now "Y" %} Taita Taveta University. All rights reserved.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Highlight the current section in the sidebar
        function highlightCurrentSection() {
            const sections = document.querySelectorAll('.doc-section');
            const navLinks = document.querySelectorAll('.doc-sidebar a');
            
            let currentSectionIndex = 0;
            const scrollPosition = window.scrollY;
            
            sections.forEach((section, index) => {
                const sectionTop = section.offsetTop - 100;
                const sectionBottom = sectionTop + section.offsetHeight;
                
                if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                    currentSectionIndex = index;
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('font-bold', 'text-ttu-dark');
            });
            
            if (navLinks[currentSectionIndex]) {
                navLinks[currentSectionIndex].classList.add('font-bold', 'text-ttu-dark');
            }
        }
        
        // Initialize any collapsible sections
        const toggleButtons = document.querySelectorAll('.faq-toggle');
        toggleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                content.classList.toggle('hidden');
                const icon = button.querySelector('i');
                icon.classList.toggle('rotate-180');
            });
        });
        
        // Make external links open in a new tab
        document.querySelectorAll('.prose a').forEach(link => {
            if (link.hostname !== window.location.hostname) {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            }
        });
        
        // Update active section on scroll
        window.addEventListener('scroll', highlightCurrentSection);
        highlightCurrentSection(); // Initial call
        
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                
                if (targetElement) {
                    window.scrollTo({
                        top: targetElement.offsetTop - 80,
                        behavior: 'smooth'
                    });
                    
                    // Update URL hash without scrolling
                    history.pushState(null, null, targetId);
                }
            });
        });
    });
</script>
{% endblock %}