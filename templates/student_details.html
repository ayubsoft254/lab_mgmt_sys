{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const rateModal = document.getElementById('rateStudentModal');
    const rateStudentNameDisplay = document.getElementById('rateStudentNameDisplay');
    const rateStudentIdInput = document.getElementById('rate_student_id');
    const bookingSelect = document.getElementById('booking_select');
    const sessionSelect = document.getElementById('session_select');
    const starButtons = document.querySelectorAll('.star-btn');
    const scoreInput = document.getElementById('score_value');
    const ratingText = document.getElementById('rating-text');
    const submitRatingBtn = document.getElementById('submit-rating');
    const rateForm = document.getElementById('rateStudentForm');

    // Event Delegation for Rate Buttons
    document.addEventListener('click', function(e) {
        const rateBtn = e.target.closest('.rate-student-btn');
        if (rateBtn) {
            const studentId = rateBtn.dataset.studentId;
            const studentName = rateBtn.dataset.studentName;
            
            rateStudentNameDisplay.textContent = studentName;
            rateStudentIdInput.value = studentId;
            
            // Reset form
            resetRatingForm();
            
            // Load bookings
            loadStudentBookings(studentId, rateBtn.dataset.bookingsUrl);
            
            // Show modal
            rateModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // Close modal handlers
        if (e.target.closest('.closeRateModal') || e.target === rateModal) {
            closeModal();
        }
    });

    // Star Rating
    starButtons.forEach(button => {
        button.addEventListener('click', function() {
            const score = parseInt(this.dataset.score);
            scoreInput.value = score;
            
            // Update stars display
            starButtons.forEach((btn, index) => {
                btn.classList.toggle('text-yellow-400', index < score);
                btn.classList.toggle('text-gray-300', index >= score);
            });
            
            // Update rating text
            const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            ratingText.textContent = ratingTexts[score];
            submitRatingBtn.disabled = false;
        });
    });

    // Rating Type Change
    document.querySelectorAll('input[name="rating_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            bookingSelect.disabled = this.value !== 'booking';
            sessionSelect.disabled = this.value !== 'session';
            
            if (this.value === 'session' && sessionSelect.options.length <= 1) {
                const studentId = rateStudentIdInput.value;
                const sessionsUrl = document.querySelector('.rate-student-btn').dataset.sessionsUrl;
                loadStudentSessions(studentId, sessionsUrl);
            }
        });
    });

    // Form Submission
    rateForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate form
        if (!validateRatingForm()) return;
        
        try {
            // Show loading state
            submitRatingBtn.disabled = true;
            submitRatingBtn.innerHTML = '<span class="animate-pulse">Submitting...</span>';
            
            const formData = new FormData(this);
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error || 'Failed to submit rating');
            
            showAlert('success', 'Rating submitted successfully!');
            setTimeout(() => window.location.reload(), 1500);
            
        } catch (error) {
            console.error('Rating submission error:', error);
            showAlert('error', error.message || 'Failed to submit rating');
            submitRatingBtn.disabled = false;
            submitRatingBtn.innerHTML = 'Submit Rating';
        }
    });

    // Helper Functions
    async function loadStudentBookings(studentId, url) {
        try {
            bookingSelect.innerHTML = '<option value="">Loading bookings...</option>';
            const response = await fetch(url);
            
            if (!response.ok) throw new Error('Failed to load bookings');
            
            const data = await response.json();
            
            if (!data.bookings || data.bookings.length === 0) {
                bookingSelect.innerHTML = '<option value="">No bookings found</option>';
                return;
            }
            
            let options = '<option value="">Select a booking</option>';
            data.bookings.forEach(booking => {
                const date = new Date(booking.start_time);
                options += `<option value="${booking.id}">${date.toLocaleString()} - Computer #${booking.computer_number}</option>`;
            });
            
            bookingSelect.innerHTML = options;
        } catch (error) {
            console.error('Error loading bookings:', error);
            bookingSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
        }
    }

    async function loadStudentSessions(studentId, url) {
        try {
            sessionSelect.innerHTML = '<option value="">Loading sessions...</option>';
            const response = await fetch(url);
            
            if (!response.ok) throw new Error('Failed to load sessions');
            
            const data = await response.json();
            
            if (!data.sessions || data.sessions.length === 0) {
                sessionSelect.innerHTML = '<option value="">No sessions found</option>';
                return;
            }
            
            let options = '<option value="">Select a session</option>';
            data.sessions.forEach(session => {
                const date = new Date(session.start_time);
                options += `<option value="${session.id}">${date.toLocaleDateString()} - ${session.title}</option>`;
            });
            
            sessionSelect.innerHTML = options;
        } catch (error) {
            console.error('Error loading sessions:', error);
            sessionSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
        }
    }

    function validateRatingForm() {
        const ratingType = document.querySelector('input[name="rating_type"]:checked');
        const score = parseInt(scoreInput.value);
        
        if (!ratingType) {
            showAlert('error', 'Please select rating type');
            return false;
        }
        
        if (isNaN(score) {
            showAlert('error', 'Please select a rating score');
            return false;
        }
        
        if (ratingType.value === 'booking' && !bookingSelect.value) {
            showAlert('error', 'Please select a booking');
            return false;
        }
        
        if (ratingType.value === 'session' && !sessionSelect.value) {
            showAlert('error', 'Please select a session');
            return false;
        }
        
        return true;
    }

    function resetStars() {
        scoreInput.value = '';
        starButtons.forEach(btn => {
            btn.classList.remove('text-yellow-400');
            btn.classList.add('text-gray-300');
        });
        ratingText.textContent = 'Select rating';
        submitRatingBtn.disabled = true;
        submitRatingBtn.innerHTML = 'Submit Rating';
    }

    function resetRatingForm() {
        rateForm.reset();
        resetStars();
        document.getElementById('rate_booking').checked = true;
        bookingSelect.disabled = false;
        sessionSelect.disabled = true;
        bookingSelect.innerHTML = '<option value="">Select a booking</option>';
        sessionSelect.innerHTML = '<option value="">Select a session</option>';
    }

    function closeModal() {
        rateModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        resetRatingForm();
    }

    function showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `fixed top-5 right-5 p-4 ${type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700'} border-l-4 z-50`;
        alert.innerHTML = `<p class="font-bold">${type === 'success' ? 'Success!' : 'Error!'}</p><p>${message}</p>`;
        
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
});
</script>
{% endblock %}